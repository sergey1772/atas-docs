# Подробное руководство по пространству имен ATAS.DataFeedsCore

Данный документ представляет собой методическое руководство по пространству имен `ATAS.DataFeedsCore`, с акцентом на его классы, интерфейсы, перечисления и связанные пространства имен. Руководство ориентировано на использование в разработке торговых платформ с применением .NET 8. Документ предназначен для разработчиков, стремящихся глубоко понять и эффективно использовать функционал ядра данных ATAS для создания надежных финансовых приложений.

---

## Обзор пространства имен ATAS.DataFeedsCore

Пространство имен `ATAS.DataFeedsCore` является ключевым компонентом платформы ATAS, предназначенным для работы с потоками данных, торговыми операциями и связанными финансовыми сущностями. Оно предоставляет широкий набор классов, интерфейсов и перечислений для управления рыночными данными, торговыми позициями, ролями пользователей, комиссиями и другими аспектами. Пространство имен поддерживает асинхронные операции, обработку рыночных данных в реальном времени и расширяемые торговые функции.

### Подпространства имен

`ATAS.DataFeedsCore` включает несколько подпространств имен, каждое из которых отвечает за определенные аспекты платформы:

- **Commissions**: Управление комиссиями.
- **ConnectorWebsocket**: Обработка WebSocket-соединений для получения данных в реальном времени.
- **Database**: Взаимодействие с базами данных.
- **Dom**: Вероятно, связано с моделью документа или глубиной рынка (Depth of Market).
- **Exceptions**: Определение пользовательских исключений для обработки ошибок.
- **Rebate**: Управление возвратами комиссий.
- **SessionServer**: Управление сессиями.
- **Statistics**: Инструменты для статистического анализа.
- **TradeStatistics**: Статистика, связанная с торговыми операциями.

---

## Классы и интерфейсы

Ниже представлен подробный разбор ключевых классов и интерфейсов пространства имен `ATAS.DataFeedsCore`, сгруппированных по функциональности.

### Классы коннекторов

#### AsyncConnector
- **Описание**: Базовый класс коннектора, поддерживающий асинхронные операции с использованием `await` для переключения на поток очереди коннектора.
- **Основные возможности**:
  - Обеспечивает интеграцию с асинхронными моделями программирования.
  - Управляет синхронизацией потоков для операций с данными.
- **Применение**: Подходит для создания коннекторов, обрабатывающих высокочастотные обновления рыночных данных.

#### BaseConnector
- **Описание**: Фундаментальный класс коннектора, предоставляющий базовую функциональность для подключения к потокам данных.
- **Основные возможности**:
  - Служит основой для специализированных коннекторов (например, `CryptoAsyncConnector`).
  - Управляет жизненным циклом соединения и базовыми операциями с данными.
- **Применение**: Используется как шаблон для создания пользовательских коннекторов.

#### BasketConnector
- **Описание**: Управляет набором коннекторов для агрегированных потоков данных.
- **Основные возможности**:
  - Поддерживает несколько источников данных через `BasketConnectorSettings`.
  - Облегчает реализацию сложных торговых стратегий с использованием нескольких инструментов.
- **Применение**: Подходит для торговых систем, работающих с портфелями.

#### CryptoAsyncConnector
- **Описание**: Специализированный асинхронный коннектор для криптовалютных рынков.
- **Основные возможности**:
  - Реализует интерфейс `ICryptoKeySecretConnector` для безопасной работы с ключами API.
  - Оптимизирован для потоков данных с криптовалютных бирж.
- **Применение**: Используется в приложениях, ориентированных на торговлю криптовалютами.

### Классы рыночных данных

#### MarketDepth
- **Описание**: Представляет данные глубины рынка, включая информацию о bid/ask на различных ценовых уровнях.
- **Основные возможности**:
  - Реализует интерфейс `IMarketDepth`.
  - Поддерживает обновления глубины рынка в реальном времени.
- **Применение**: Необходим для визуализации книги ордеров.

#### MarketByOrder
- **Описание**: Представляет данные Market by Order (MBO), предоставляя подробную информацию о книге ордеров.
- **Основные возможности**:
  - Предоставляет данные о позициях в очереди и размерах ордеров.
  - Поддерживает `MarketByOrderUpdateTypes` для операций моментального снимка, добавления, изменения и удаления.
- **Применение**: Используется в системах высокочастотной торговли, требующих детализированных данных об ордерах.

#### UniversalMarketData
- **Описание**: Универсальный класс для представления различных типов рыночных данных.
- **Ключевые свойства**:
  - `Ecn`: Идентификатор электронной сети (`string`).
  - `Price`: Рыночная цена (`decimal`).
  - `Volume`: Объем торгов (`decimal`).
  - `OrdersCount`: Количество ордеров (`int`).
  - `Time`: Временная метка (`DateTime`).
  - `Type`: Тип рыночных данных (`MarketDataType`).
  - `Direction`: Направление сделки (`TradeDirection`).
- **Применение**: Подходит для приложений, требующих гибкого представления рыночных данных.

### Торговые сущности

#### Trade
- **Описание**: Представляет отдельную сделку (тик) на финансовой бирже.
- **Ключевые свойства**:
  - `Id`: Уникальный идентификатор сделки (`long`).
  - `OrderDirection`: Направление сделки (`TradeDirection`).
  - `Price`: Цена сделки (`decimal`).
  - `Security`: Связанный инструмент (`Security`).
  - `Time`: Временная метка сделки (`DateTime`).
  - `Volume`: Объем сделки (`decimal`).
  - `OpenInterest`: Открытый интерес (`decimal`).
  - `ECN`: Идентификатор сети (`string`).
  - `AggressorExchangeOrderId`: Идентификатор агрессорного ордера (`long?`).
  - `ExchangeOrderId`: Идентификатор биржевого ордера (`long?`).
- **Применение**: Используется для логирования и анализа сделок.

#### Order
- **Описание**: Представляет торговый ордер на финансовой бирже.
- **Основные возможности**:
  - Поддерживает различные типы ордеров (`OrderTypes`: Limit, Market, Stop, StopLimit).
  - Отслеживает состояния ордеров (`OrderStates`: None, Active, Done, Failed).
  - Реализует опции, такие как `IOrderOptionPostOnly`, `IOrderOptionReduceOnly`.
- **Применение**: Необходим для систем управления ордерами.

#### Position
- **Описание**: Представляет торговую позицию, удерживаемую пользователем.
- **Основные возможности**:
  - Отслеживает размер позиции, среднюю цену и нереализованную прибыль/убыток.
  - Поддерживает `PositionAveragePriceValueTypes` для методов расчета средней цены.
- **Применение**: Используется в модулях управления портфелем и рисками.

#### Portfolio
- **Описание**: Представляет портфель пользователя, включая баланс, прибыль/убыток и торговые опции.
- **Ключевые свойства**:
  - `BlockBalance`: Заблокированный баланс (`decimal`).
  - `MaxDrawdown`: Максимально допустимая просадка (`decimal`).
  - `MaxUnrealizedPnL`: Максимальная нереализованная прибыль/убыток (`decimal`).
  - `TradingOptions`: Связанные торговые опции (`TradingOptions`).
- **Применение**: Центральный элемент для управления портфелем и отслеживания производительности.

### Управление комиссиями

#### CommissionGroup
- **Пространство имен**: `ATAS.DataFeedsCore.Commissions`
- **Описание**: Управляет группами правил комиссий.
- **Ключевые свойства**:
  - `Id`: Уникальный идентификатор (`long`).
  - `GroupId`: Идентификатор родительской группы (`long`).
  - `Name`: Название группы (`string`).
  - `Rules`: Список правил комиссий (`List<CommissionGroupItem>`).
- **Наследование**:
  - Реализует `IEntity` и `INotifyPropertyChanged`.
- **Применение**: Используется для настройки и применения структуры комиссий.

#### CommissionGroupItem
- **Пространство имен**: `ATAS.DataFeedsCore.Commissions`
- **Описание**: Представляет отдельный элемент в группе комиссий.
- **Ключевые свойства**:
  - `GroupId`: Идентификатор группы (`long`).
  - `TypeName`: Название типа правила (`string`).
  - `Settings`: Настройки правила (`string`).
  - `Rule`: Правило комиссии (`ICommissionRule`).
- **Применение**: Определяет конкретные правила комиссий в группе.

#### PercentCommissionRule
- **Пространство имен**: `ATAS.DataFeedsCore.Commissions`
- **Описание**: Реализует правило комиссии на основе процента.
- **Основные возможности**:
  - Рассчитывает комиссию как процент от стоимости сделки.
  - Реализует интерфейс `ICommissionRule`.
- **Применение**: Распространено в торговле акциями и валютой.

#### PerContractCommissionRule
- **Пространство имен**: `ATAS.DataFeedsCore.Commissions`
- **Описание**: Реализует правило комиссии за контракт.
- **Основные возможности**:
  - Взимает фиксированную комиссию за каждый торгуемый контракт.
  - Реализует интерфейс `ICommissionRule`.
- **Применение**: Типично для торговли фьючерсами и опционами.

#### PerTradeCommissionRule
- **Пространство имен**: `ATAS.DataFeedsCore.Commissions`
- **Описание**: Реализует правило комиссии за сделку.
- **Основные возможности**:
  - Взимает фиксированную комиссию за каждую выполненную сделку.
  - Реализует интерфейс `ICommissionRule`.
- **Применение**: Используется в сценариях с фиксированными сборами за сделку.

### Управление пользователями

#### User
- **Описание**: Представляет сущность пользователя на платформе ATAS.
- **Ключевые свойства**:
  - `Id`: Уникальный идентификатор пользователя (`long`).
  - `Login`: Логин пользователя (`string`).
  - `Password`: Пароль пользователя (`string`).
  - `Email`: Электронная почта пользователя (`string`).
  - `Group`: Группа пользователя (`UserGroup`).
  - `Role`: Роль пользователя (`UserRole`).
  - `Portfolios`: Список портфелей пользователя (`List<Portfolio>`).
- **Ключевые методы**:
  - `Check(string password)`: Проверяет пароль пользователя.
  - `Update(string password)`: Обновляет пароль пользователя.
  - `SetFakePassword()`: Устанавливает временный пароль (цель неясна).
- **Применение**: Управляет аутентификацией и правами пользователей.

#### UserGroup
- **Описание**: Представляет группу пользователей с общими настройками.
- **Ключевые свойства**:
  - `Id`: Идентификатор группы (`long`).
  - `Code`: Код группы (`string`).
  - `Name`: Название группы (`string`).
  - `TradingOptions`: Связанные торговые опции (`TradingOptions`).
  - `Exchanges`: Список поддерживаемых бирж (`List<Exchange>`).
- **Применение**: Организует пользователей для административных целей.

#### UserRole
- **Описание**: Определяет роль пользователя с конкретными правами.
- **Ключевые свойства**:
  - `Id`: Идентификатор роли (`long`).
  - `Name`: Название роли (`string`).
  - `Rights`: Набор прав (`HashSet<EntityAction>`).
- **Применение**: Управляет контролем доступа на платформе.

#### UserRoleRight
- **Описание**: Связывает конкретное действие с ролью пользователя.
- **Ключевые свойства**:
  - `UserRoleId`: Идентификатор роли (`long`).
  - `Action`: Разрешенное действие (`EntityAction`).
- **Применение**: Гранулярное управление правами.

#### UserChange
- **Описание**: Отслеживает изменения данных пользователя.
- **Ключевые свойства**:
  - `Id`: Идентификатор изменения (`long`).
  - `UserId`: Идентификатор затронутого пользователя (`long`).
  - `AdminId`: Идентификатор администратора, внесшего изменение (`long`).
  - `ChangeType`: Тип изменения (`UserChangeTypes`).
  - `Value`: Детали изменения (`string`).
- **Применение**: Аудит изменений пользовательских данных.

#### UserChangeHistory
- **Описание**: Расширяет `UserChange`, добавляя номер изменения.
- **Ключевые свойства**:
  - `ChangeNumber`: Порядковый номер изменения (`int`).
- **Применение**: Ведет исторический учет изменений пользователей.

### Утилитарные классы

#### TradesTimeChecker
- **Описание**: Проверяет корректность временных меток сделок.
- **Ключевые методы**:
  - `Check(Trade trade)`: Проверяет временную метку сделки.
  - `Reset()`: Сбрасывает состояние проверки.
- **Применение**: Гарантирует соответствие временных меток сделок рыночным часам.

#### TradingOptions
- **Описание**: Настраивает параметры торговли для портфеля или группы пользователей.
- **Ключевые свойства**:
  - `Leverage`: Плечо торговли (`decimal`).
  - `MaxPositions`: Максимальное количество позиций (`int`).
  - `MaxDrawdown`: Лимит максимальной просадки (`decimal`).
  - `Commission`: Связанная группа комиссий (`CommissionGroup`).
  - `SessionBeginTime`: Начало торговой сессии (`TimeSpan`).
  - `SessionEndTime`: Окончание торговой сессии (`TimeSpan`).
- **Применение**: Определяет торговые ограничения и параметры риска.

#### WorkingTime
- **Описание**: Определяет рабочие часы биржи.
- **Ключевые свойства**:
  - `Exchange`: Идентификатор биржи (`string`).
  - `StartDay`: Начальный день недели (`DayOfWeek`).
  - `StartTime`: Время начала (`TimeSpan`).
  - `EndDay`: Конечный день недели (`DayOfWeek`).
  - `EndTime`: Время окончания (`TimeSpan`).
- **Ключевые методы**:
  - `IsWorkingTime(DateTime time)`: Проверяет, попадает ли время в рабочие часы.
  - `Clone()`: Создает копию конфигурации рабочего времени.
- **Применение**: Управляет расписанием торгов на бирже.

#### VolumeUnit
- **Описание**: Структура, представляющая единицу объема.
- **Ключевые свойства**:
  - `Type`: Тип единицы объема (`VolumeUnitTypes`).
  - `Value`: Значение объема (`decimal`).
- **Применение**: Стандартизирует представление объемов на платформе.

---

## Перечисления

Пространство имен `ATAS.DataFeedsCore` определяет несколько перечислений для категоризации данных и состояний:

- **Currencies**: Поддерживаемые валюты (например, USD, EUR, BTC, ETH).
- **EcnId**: Идентификаторы электронных сетей (например, NASDAQ, NYSE).
- **EntityAction**: Действия, такие как Logon, UserAdd, OrderRegister.
- **MarketDataType**: Типы рыночных данных (Bid, Ask, Trade).
- **OrderDirections**: Направление ордера (Buy, Sell).
- **OrderStates**: Состояния ордера (None, Active, Done, Failed).
- **OrderTypes**: Типы ордеров (Limit, Market, Stop, StopLimit).
- **TradeDirection**: Направление сделки (Buy, Sell, Between).
- **VolumeUnitTypes**: Типы единиц объема (Absolute, Percent).

---

## Пример реализации: Логгер сделок

Ниже приведен пример реализации, демонстрирующий использование ключевых классов `ATAS.DataFeedsCore` для логирования сделок в приложении на .NET 8.

```csharp
using ATAS.DataFeedsCore;
using System;
using System.Collections.Generic;

namespace TradeLoggerApp
{
    public class TradeLogger
    {
        private readonly List<Trade> _trades = new List<Trade>();
        private readonly TradesTimeChecker _timeChecker = new TradesTimeChecker();

        public void LogTrade(Trade trade)
        {
            // Проверка временной метки сделки
            _timeChecker.Check(trade);

            // Добавление сделки в коллекцию
            _trades.Add(trade);

            // Логирование деталей сделки
            Console.WriteLine($"Сделка зарегистрирована: ID={trade.Id}, Инструмент={trade.Security}, " +
                              $"Цена={trade.Price}, Объем={trade.Volume}, " +
                              $"Направление={trade.OrderDirection}, Время={trade.Time}");
        }

        public void ResetLogger()
        {
            _timeChecker.Reset();
            _trades.Clear();
            Console.WriteLine("Логгер сделок сброшен.");
        }
    }

    class Program
    {
        static void Main(string[] args)
        {
            var logger = new TradeLogger();

            // Создание примера сделки
            var trade = new Trade
            {
                Id = 1,
                Security = new Security { Name = "BTC/USD" },
                Price = 50000.00m,
                Volume = 1.5m,
                OrderDirection = TradeDirection.Buy,
                Time = DateTime.Now,
                ECN = "BINANCE"
            };

            // Регистрация сделки
            logger.LogTrade(trade);

            // Сброс логгера
            logger.ResetLogger();
        }
    }
}
```

<xaiArtifact artifact_id="a8780359-b1ad-45e8-b33c-492f56c71c23" artifact_version_id="f6752848-2152-4113-acc8-e6adb0bb310d" title="TradeLogger.cs" contentType="text/csharp">
using ATAS.DataFeedsCore;
using System;
using System.Collections.Generic;

namespace TradeLoggerApp
{
    public class TradeLogger
    {
        private readonly List<Trade> _trades = new List<Trade>();
        private readonly TradesTimeChecker _timeChecker = new TradesTimeChecker();

        public void LogTrade(Trade trade)
        {
            _timeChecker.Check(trade);
            _trades.Add(trade);
            Console.WriteLine($"Сделка зарегистрирована: ID={trade.Id}, Инструмент={trade.Security}, " +
                              $"Цена={trade.Price}, Объем={trade.Volume}, " +
                              $"Направление={trade.OrderDirection}, Время={trade.Time}");
        }

        public void ResetLogger()
        {
            _timeChecker.Reset();
            _trades.Clear();
            Console.WriteLine("Логгер сделок сброшен.");
        }
    }

    class Program
    {
        static void Main(string[] args)
        {
            var logger = new TradeLogger();
            var trade = new Trade
            {
                Id = 1,
                Security = new Security { Name = "BTC/USD" },
                Price = 50000.00m,
                Volume = 1.5m,
                OrderDirection = TradeDirection.Buy,
                Time = DateTime.Now,
                ECN = "BINANCE"
            };
            logger.LogTrade(trade);
            logger.ResetLogger();
        }
    }
}
